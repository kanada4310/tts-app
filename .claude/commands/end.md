---
description: セッション終了時に作業内容を記録して次回に備える
---

# セッション終了プロトコル

このセッションで実施した作業を記録し、次回セッションがスムーズに開始できるように準備します。

## フェーズ1: 作業内容の振り返り

以下の質問に基づいて、このセッションの内容を整理してください:

### 1. 実施した作業
- 何を実装・修正・追加しましたか？
- どのファイルを作成・編集しましたか？
- どの機能が完成しましたか？

### 2. 技術的決定事項
- 重要な設計・実装の判断はありましたか？
- なぜその方法を選択しましたか？
- 代替案はありましたか？

### 3. 発生した問題と解決
- どんな問題・エラーが発生しましたか？
- どのように解決しましたか？
- 解決に時間がかかった理由は？

### 4. 未完了・保留事項
- 完了しなかったタスクは何ですか？
- 保留にした理由は？
- 次回優先すべきタスクは？

### 5. 学んだこと・気づき
- このセッションで得た知見は？
- 改善できる点は？

## フェーズ2: ファイル変更の確認

以下のコマンドで変更内容を確認:

```bash
# 変更されたファイルのリスト
git status

# 変更内容の詳細
git diff
```

変更されたファイルをリストアップし、それぞれの変更理由を記録してください。

## フェーズ3: セッション管理ファイルの更新

### 3.0 SESSION_HISTORY.mdへのアーカイブ（重要）

**目的**: HANDOVER.mdの肥大化を防ぎ、/start時のトークン消費を削減

1. **現在のHANDOVER.mdから前々回以前のセッションを抽出**
   - セッション番号を確認（現在が#Nなら、#N-2以前をアーカイブ）
   - 前回セッション（#N-1）は残してもよい（直近の参考として）

2. **SESSION_HISTORY.mdに追加**
   - `docs/sessions/SESSION_HISTORY.md`の目次を更新
   - 新しいセッションを**先頭**に追加（新しい順）
   - マークダウンのアンカーリンクが正しく機能するよう確認

3. **HANDOVER.mdの整理**
   - アーカイブしたセッションをHANDOVER.mdから削除
   - 最新セッション（#N）と前回セッション（#N-1、オプション）のみ残す

### 3.1 HANDOVER.md の更新

`docs/sessions/HANDOVER.md`に以下の形式で新しいセクションを**追加**:

```markdown
## セッション #X - YYYY-MM-DD

### 実施内容

#### 1. [作業内容のタイトル]
- 実施した具体的な作業
- 作成・編集したファイル
- 実装した機能

#### 2. [技術的決定事項のタイトル]
- 決定内容
- 選択理由
- 代替案との比較

### 発生した問題と解決

**問題**: [問題の説明]
- 原因: [原因]
- 解決方法: [解決方法]
- 所要時間: [時間]

### 次セッションへの引き継ぎ事項

#### すぐに着手すべきこと
1. [タスク1]
2. [タスク2]

#### 注意事項
- [注意点1]
- [注意点2]

### 成果物リスト
- [x] [ファイル名] - [説明]
- [x] [ファイル名] - [説明]
```

**注意**:
- 最新セッションのみHANDOVER.mdに記載
- 古いセッションは3.0でSESSION_HISTORY.mdにアーカイブ済み

### 3.2 SUMMARY.md の更新

`docs/sessions/SUMMARY.md`を更新:

1. **進捗率の計算と更新**
   - 完了した項目数をカウント
   - 全体タスク数との比率で進捗率を算出
   - プログレスバーを更新

2. **完了した項目の追加**
   - 該当セクション（バックエンド/フロントエンド/インフラ）に完了項目を追加
   - チェックマーク [x] を付ける

3. **統計情報の更新**
   - セッション数: +1
   - 総開発時間: 累積
   - 完了タスク数: 累積
   - コミット数: 現在の数

### 3.3 TODO.md の更新

`docs/sessions/TODO.md`を更新:

1. **完了タスクのチェック**
   - 完了したタスクに [x] をつける
   - または完全に削除（アーカイブ）

2. **新規タスクの追加**
   - このセッションで判明した新しいタスクを追加
   - 適切な優先度 (🔴🟡🟢🔵) を設定
   - 所要時間を見積もり

3. **優先度の見直し**
   - 次セッションの最優先タスク（🔴）が適切か確認
   - 依存関係に基づいて順序を調整

4. **最終更新日の更新**
   - 先頭の「最終更新: YYYY-MM-DD」を今日の日付に

## フェーズ4: Git コミット（オプション）

セッション中に作業した内容をコミットする場合:

```bash
# 変更をステージング
git add .

# コミット（メッセージはセッション内容を反映）
git commit -m "セッション#X: [作業内容の要約]

- [変更1]
- [変更2]
- [変更3]

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# GitHubにプッシュ（オプション）
git push
```

**コミットメッセージのガイドライン:**
- 1行目: セッション番号と作業内容の要約（50文字以内）
- 空行
- 詳細な変更内容（箇条書き）
- 空行
- 署名

## フェーズ5: 次回セッションの準備

### 5.1 次回の最優先タスクを明確化

TODO.mdの🔴マークのタスクが次回すぐに着手できる状態か確認:

- [ ] 必要な情報は揃っているか
- [ ] 依存するタスクは完了しているか
- [ ] 実装方針は明確か

不明点があれば、TODO.mdに「事前確認事項」として記載。

### 5.2 必要なファイルのメモ

次回セッションで必要になりそうなファイルを`docs/sessions/TODO.md`の備考欄に記載:

```markdown
## 📝 備考

**次回セッションで参照すべきファイル:**
- backend/app/api/routes/ocr.py - OCR実装の参考
- docs/API.md - エンドポイント仕様
```

### 5.3 環境の確認

次回セッション前に準備すべき環境をメモ:

```markdown
**次回セッション前の準備:**
- [ ] バックエンドの依存関係をインストール (pip install -r requirements.txt)
- [ ] .envファイルにAPIキーを設定
- [ ] データベースのマイグレーション実行
```

## フェーズ6: セッション統計の記録

`docs/sessions/SUMMARY.md`の最後に統計を追加・更新:

```markdown
## 📊 セッション履歴

| # | 日付 | 作業時間 | 完了タスク | 主な成果 |
|---|------|---------|-----------|---------|
| 1 | 2025-10-20 | 1.5h | 18 | プロジェクト初期化、GitHub連携 |
| 2 | YYYY-MM-DD | Xh | N | [主な成果] |
```

## 完了チェックリスト

セッション終了前に以下を確認:

- [ ] HANDOVER.mdに今回のセッション内容を追加
- [ ] SUMMARY.mdの進捗率を更新
- [ ] SUMMARY.mdの完了項目を更新
- [ ] TODO.mdの完了タスクをチェック
- [ ] TODO.mdに新規タスクを追加
- [ ] TODO.mdの優先度を見直し
- [ ] （オプション）Gitコミット・プッシュ
- [ ] 次回の最優先タスクが明確
- [ ] 次回必要なファイル・環境をメモ

## 最後に

セッション終了メッセージを表示:

```
✅ セッション #X 終了

📊 本日の成果:
- 完了タスク: N個
- 作業時間: Xh
- 進捗: XX% → YY% (+Z%)

🎯 次回セッション:
- 最優先: [TODO.mdの🔴タスク]
- 準備: [必要な準備事項]

お疲れ様でした！次回は /start コマンドで開始してください。
```

## テンプレート例

### セッション記録のテンプレート（参考）

```markdown
## セッション #2 - 2025-10-21

### 実施内容

#### 1. OCRエンドポイントの実装
- `backend/app/api/routes/ocr.py`に画像処理とClaude API連携を実装
- `backend/app/schemas/ocr.py`にOCRRequest/Responseスキーマを定義
- `backend/app/services/claude_service.py`にClaude APIクライアントを実装
- 画像のbase64デコードとバリデーションを追加

**技術的決定**:
- Claude API: Sonnet 4.5を使用（理由: 最新モデル、高精度）
- エラーハンドリング: カスタムOCRErrorクラスを使用
- タイムアウト: 30秒に設定（理由: API仕様に準拠）

#### 2. 画像圧縮機能の実装
- `backend/app/utils/image_processing.py`に圧縮ロジックを実装
- Pillowを使用して長辺2000px、品質85%に自動圧縮
- 対応形式: JPEG, PNG

### 発生した問題と解決

**問題**: Claude APIのレート制限エラー
- 原因: 短時間に大量リクエストを送信
- 解決方法: exponential backoffによるリトライ機構を実装
- 所要時間: 30分

**問題**: base64デコード時のメモリエラー
- 原因: 大きすぎる画像
- 解決方法: 事前にサイズチェックを追加（10MB制限）
- 所要時間: 15分

### 次セッションへの引き継ぎ事項

#### すぐに着手すべきこと
1. TTSエンドポイントの実装（OpenAI API連携）
2. OCRエンドポイントのテスト作成
3. エラーレスポンスの統一化

#### 注意事項
- Claude APIキーは.envファイルで管理（コミット禁止）
- 画像処理は非同期処理を検討（大きいファイル対応）
- レート制限対策のキャッシュ機構を将来的に実装

### 成果物リスト
- [x] backend/app/api/routes/ocr.py - OCRエンドポイント
- [x] backend/app/schemas/ocr.py - Pydanticスキーマ
- [x] backend/app/services/claude_service.py - Claude APIクライアント
- [x] backend/app/utils/image_processing.py - 画像圧縮
- [x] backend/tests/test_ocr.py - 基本的なユニットテスト
```
