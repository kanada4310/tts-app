# TODO

最終更新: 2025-10-22（セッション#14: ドキュメント整合性修正）

## 🟢 完了済み（セッション#13で実装完了）

### ユーザビリティ改善 - フェーズ1（即時改善）✅ 完了

**目標**: 高校生が使える最低限の日本語化と視覚的フィードバック
**期待効果**: タスク完了率+35%, 初回離脱率-40%
**参照**: [docs/USABILITY_REPORT.md](../USABILITY_REPORT.md)
**完了日**: 2025-10-22（セッション#13）

- [x] **1. 日本語UI対応（全画面）** ✅
  - [x] App.tsx: ヘッダー、エラーバナー、ウェルカムメッセージ
  - [x] ImageUpload: アップロードプロンプト、進捗メッセージ
  - [x] TextEditor: ヘッダー、プレースホルダー、ボタン
  - [x] AudioPlayer: ヘッダー、コントロールボタン、ポーズ設定
  - [x] 新規ファイル: `frontend/src/constants/messages.ts` (83行)
  - 所要時間: 1-2時間（実績: 約1.5時間）
  - ROI: ⭐⭐⭐⭐⭐

- [x] **2. TTS生成の進捗バー** ✅
  - [x] フロントエンド: プログレスバーコンポーネント作成
  - [x] TextEditor: 進捗表示UI（109-118行目）
  - [x] 予想残り時間表示（"約20秒"）
  - [x] アニメーション付きプログレスバー
  - [x] 文数から生成時間を推定（1文あたり約2秒）
  - 所要時間: 2-3時間（実績: 約2時間）
  - ROI: ⭐⭐⭐⭐⭐

- [x] **3. エラーメッセージの具体化** ✅
  - [x] 画像処理エラー: サイズ、形式、接続の確認手順
  - [x] TTS生成エラー: 文字数、接続の確認手順
  - [x] OCRエラー: 画像品質、形式の確認手順
  - [x] messages.ts: 詳細なエラーメッセージ追加
  - 所要時間: 1-2時間（実績: 約1時間）
  - ROI: ⭐⭐⭐⭐

- [x] **4. 速度プリセット1.5x, 2.0x追加** ✅
  - [x] AudioPlayer: プリセットを6つに拡大（0.5x, 0.75x, 1.0x, 1.25x, 1.5x, 2.0x）
  - [x] レイアウト調整（横並び維持）
  - 所要時間: 30分（実績: 30分）
  - ROI: ⭐⭐⭐⭐

- [x] **5. 文字数制限の明示** ✅
  - [x] TextEditor: "350 / 100,000 文字"表示
  - [x] 90,000文字超: 黄色警告（"上限に近づいています"）
  - [x] 100,000文字超: 赤色警告（"上限を超えています。音声生成できません。"）
  - [x] CSS: 警告時の色分け（warning, error）
  - 所要時間: 30分（実績: 30分）
  - ROI: ⭐⭐⭐

- [x] **6. アップロード前の制限警告** ✅
  - [x] ImageUpload: 最大10枚の明示（"※ 最大10枚までアップロード可能"）
  - [x] 11枚以上選択時: 自動で最初の10枚のみ処理＋警告バナー表示
  - [x] CSS: 警告バナー（アニメーション付き）
  - 所要時間: 1時間（実績: 1時間）
  - ROI: ⭐⭐⭐⭐

**フェーズ1合計**: 6-9時間（実績: 約6.5時間）

---

### 生徒向け使用ガイド作成

- [x] **USER_GUIDE.md作成** ✅
  - [x] アプリURL（https://tts-app-ycaz.vercel.app）と概要
  - [x] 基本的な使い方（画像アップロード→OCR→TTS→再生）
  - [x] 各機能の説明（速度調整、ポーズ機能、文ナビゲーション）
  - [x] トラブルシューティング（よくある問題と解決方法）
  - 所要時間: 30分（実績: 15分）

### デプロイ関連（✅ 完了）

- [x] **Railwayへのバックエンドデプロイ** ✅
  - [x] Railwayアカウント作成
  - [x] プロジェクト作成とGitHub連携
  - [x] 環境変数設定（GEMINI_API_KEY, OPENAI_API_KEY）
  - [x] デプロイ実行とURL確認
  - [x] ffmpegインストール設定（aptfile）
  - [x] クロスプラットフォーム対応（openai_service.py）
  - [x] google-generativeai依存関係追加

- [x] **Vercelへのフロントエンドデプロイ** ✅
  - [x] Vercelアカウント作成
  - [x] プロジェクトインポートとGitHub連携
  - [x] 環境変数設定（VITE_API_BASE_URL）
  - [x] デプロイ実行とURL確認
  - [x] TypeScriptビルドエラー修正

- [x] **Railwayポート設定とCORSエラー解決** ✅（セッション#11）
  - [x] GitHubへ最新コードをプッシュ
  - [x] Railway Settings → Networking → Port = 8080に設定
  - [x] Railwayの自動再デプロイ確認
  - [x] CORS設定の検証（Preflightリクエスト確認）

- [x] **E2E動作確認** ✅（セッション#11）
  - [x] 画像アップロード → OCR
  - [x] TTS音声生成
  - [x] 音声再生、速度調整、ポーズ機能
  - [x] ブラウザコンソールでエラーがないことを確認

## 🟡 高優先度

### ユーザビリティ改善 - フェーズ2（使いやすさ向上）✅ 完了

**目標**: 機能発見率とモバイル体験の改善
**期待効果**: 機能利用率+50%, モバイル完了率+25%, 満足度+35%
**参照**: [docs/USABILITY_REPORT.md](../USABILITY_REPORT.md)
**完了日**: 2025-10-22（セッション#13）

- [x] **7. 初回チュートリアル/ツールチップ** ✅
  - [x] Tutorialコンポーネント作成（オーバーレイ式）
  - [x] 3ステップガイド実装
  - [x] localStorage で初回フラグ管理
  - [x] ESCキーで閉じる機能
  - 所要時間: 約3時間（実績）
  - ROI: ⭐⭐⭐⭐⭐

- [x] **8. 画像の個別削除機能** ✅
  - [x] プレビュー画像に「×」ボタン追加
  - [x] 削除後の自動再OCR実装
  - [x] フェードインアニメーション
  - [x] ProcessedImage型導入（dataUrl + base64）
  - 所要時間: 約2時間（実績）
  - ROI: ⭐⭐⭐⭐

- [x] **9. モバイルUI最適化** ✅
  - [x] シークバー高さ: 8px → 16px（スマホ時）
  - [x] コントロールボタン: 48px → 44px（スマホ時、Apple HIG準拠）
  - [x] プレイヤー固定ヘッダー化（position: sticky）
  - [x] タップエリア拡大（44px以上）
  - [x] viewport設定更新（index.html）
  - 所要時間: 約4時間（実績）
  - ROI: ⭐⭐⭐⭐

- [x] **10. キーボードショートカット** ✅
  - [x] Space/K: 再生/一時停止
  - [x] 左右矢印: 前/次の文
  - [x] 上下矢印: 速度調整
  - [x] 「?」キー: ショートカット一覧表示
  - [x] input/textareaフィールドで無効化
  - 所要時間: 約3時間（実績）
  - ROI: ⭐⭐⭐

**フェーズ2合計**: 10-14時間（実績: 約12時間）

---

### 基本実装（完了）

- [x] バックエンドの基本セットアップ ✅
- [x] バックエンドAPI実装 ✅
- [x] バックエンドのテスト実装 ✅
- [x] Gemini OCR統合 ✅
- [x] OpenAI TTS統合 ✅
- [x] エンドツーエンド統合テスト ✅

### 新機能実装

- [x] 複数画像アップロード機能実装 ✅
  - [x] バックエンド: OCRエンドポイント拡張（複数画像対応）
  - [x] バックエンド: 画像結合ロジック実装
  - [x] フロントエンド: 複数ファイル選択UI
  - [x] フロントエンド: アップロード進捗表示

- [x] AudioPlayer拡張機能実装 ✅
  - [x] テキスト解析: 文の境界検出ロジック実装
  - [x] 文ごとのポーズ挿入機能（0-5秒、0.5秒刻み）
  - [x] 文ごとのナビゲーション（前/次スキップボタン）
  - [x] シークバー上の文境界マーカー表示
  - [x] シークバーツールチップ（文の先頭5-10単語表示）
  - [x] ポーズ設定UI（有効/無効切り替え、秒数スライダー）

- [x] 正確なタイムスタンプ機能実装 ✅
  - [x] バックエンド: 文ごとのTTS生成（generate_speech_with_timings）
  - [x] バックエンド: pydubによる正確な音声長測定
  - [x] バックエンド: /api/tts-with-timings エンドポイント追加
  - [x] フロントエンド: performTTSWithTimings API関数
  - [x] フロントエンド: AudioPlayerの3段階タイムスタンプ精度システム

- [x] タイムスタンプ精度の改善（セッション#8） ✅
  - [x] ffmpegの自動検知機能実装
  - [x] opus → mp3フォーマット変更（ffmpeg互換性対応）
  - [x] 連結後の実際の長さで比例補正
  - [x] 文間に200msの無音挿入
  - [x] ポーズロジックの改善（シーク機能追加）
  - [ ] **ポーズ前の音被り問題（未完全解決）**

## 🟡 高優先度（セッション#15で追加）

### ユーザビリティ改善 - フェーズ3A: モバイル操作性の改善

**目標**: スマホでのシークバー操作を快適にする
**期待効果**: モバイル操作性+100%、機能発見率+300%、タスク完了率+15%
**参照**: [docs/USABILITY_REPORT.md](../USABILITY_REPORT.md) - モバイルユーザビリティの追加問題
**追加日**: 2025-10-22（セッション#15）

- [ ] **1. シークバーのタップエリア拡大**
  - [ ] `::before`疑似要素で透明なパディングを追加（上下20px）
  - [ ] タップ可能エリアを視覚的な高さ（16px）から44pxに拡張
  - **ファイル**: `frontend/src/components/features/AudioPlayer/styles.css`
  - 所要時間: 30分
  - ROI: ⭐⭐⭐⭐⭐

- [ ] **2. シークバー高さを24pxに拡大**
  - [ ] モバイル時のシークバー高さを16px → 24pxに変更
  - [ ] 視覚的にもタップしやすく
  - **ファイル**: `frontend/src/components/features/AudioPlayer/styles.css`
  - 所要時間: 15分
  - ROI: ⭐⭐⭐⭐⭐

- [ ] **3. 文境界マーカーを8px幅、24px高さに拡大**
  - [ ] マーカー幅: 4px → 8px
  - [ ] マーカー高さ: 16px → 24px（シークバーと統一）
  - **ファイル**: `frontend/src/components/features/AudioPlayer/styles.css`
  - 所要時間: 15分
  - ROI: ⭐⭐⭐⭐

- [ ] **4. タップでツールチップ表示機能の実装**
  - [ ] シークバーをタップ → その位置の文プレビューを固定表示
  - [ ] `handleSeekBarClick`関数実装（タップ位置から文を特定）
  - [ ] モバイル専用ツールチップUI（`position: absolute`, `z-index: 1000`）
  - [ ] 再タップまたは3秒後に自動消去
  - **ファイル**: `frontend/src/components/features/AudioPlayer/AudioPlayer.tsx`
  - **ファイル**: `frontend/src/components/features/AudioPlayer/styles.css`
  - 所要時間: 2時間
  - ROI: ⭐⭐⭐⭐⭐

- [ ] **5. 文境界マーカーに番号表示**
  - [ ] マーカーの上に文番号（"1", "2", "3"...）を小さく表示
  - [ ] `font-size: 10px`, `position: absolute`, `top: -12px`
  - [ ] 20文以上の場合は5の倍数のみ表示（1, 5, 10, 15...）
  - **ファイル**: `frontend/src/components/features/AudioPlayer/AudioPlayer.tsx`
  - **ファイル**: `frontend/src/components/features/AudioPlayer/styles.css`
  - 所要時間: 1時間
  - ROI: ⭐⭐⭐⭐

**フェーズ3A合計**: 4時間

---

### ユーザビリティ改善 - フェーズ3B: レイアウト改善

**目標**: スマホでの視認性とレイアウトを最適化
**期待効果**: 視認性+15点、画面領域の有効活用+40%

- [ ] **6. プリセットボタンを2列3行に配置（スマホのみ）**
  - [ ] 現在: 6つのボタンが横並び（0.5x, 0.75x, 1.0x, 1.25x, 1.5x, 2.0x）
  - [ ] スマホ時: 2列3行のグリッドレイアウトに変更
  - [ ] `display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;`
  - **ファイル**: `frontend/src/components/features/AudioPlayer/styles.css`
  - 所要時間: 30分
  - ROI: ⭐⭐⭐

- [ ] **7. プレイヤーの折りたたみ機能（オプション）**
  - [ ] 最小化ボタン追加（再生/一時停止、速度、シークバーのみ表示）
  - [ ] ポーズ設定、文ナビゲーションを非表示
  - [ ] 展開ボタンで全機能を再表示
  - **ファイル**: `frontend/src/components/features/AudioPlayer/AudioPlayer.tsx`
  - **ファイル**: `frontend/src/components/features/AudioPlayer/styles.css`
  - 所要時間: 2時間
  - ROI: ⭐⭐

**フェーズ3B合計**: 0.5-2.5時間

---

### 学習効果向上 - フェーズ3A: アクティブ学習支援（最優先）

**目標**: 「聞くだけ」から「練習できる」アプリへ進化
**期待効果**: 学習効果+40%、シャドーイング/オーバーラッピング練習が可能に
**参照**: [docs/LEARNING_ENHANCEMENT.md](../LEARNING_ENHANCEMENT.md)
**追加日**: 2025-10-22（セッション#15）
**理論的背景**: 第二言語習得論（SLA）、大学受験英語のノウハウ

- [ ] **1. リピート再生機能**
  - [ ] 1文を指定回数（1回、3回、5回、無限）自動リピート
  - [ ] 再生後に自動で次の文へ（設定可能）
  - [ ] UI: ドロップダウンまたはラジオボタン
  - [ ] `repeatCount`状態、`onEnded`イベントでカウント判定
  - **ファイル**: `frontend/src/components/features/AudioPlayer/AudioPlayer.tsx`
  - 所要時間: 1-2時間
  - ROI: ⭐⭐⭐⭐⭐
  - **学習効果**: オーバーラッピング、シャドーイング練習が容易に

- [ ] **2. 文ごとの一時停止機能**
  - [ ] 1文再生後、自動で一時停止
  - [ ] ユーザーが発音練習 → スペースキーで次の文へ
  - [ ] `autoPauseAfterSentence`状態
  - [ ] 文の終了タイミングで`pause()`を呼び出し
  - **ファイル**: `frontend/src/components/features/AudioPlayer/AudioPlayer.tsx`
  - 所要時間: 30分-1時間
  - ROI: ⭐⭐⭐⭐⭐
  - **学習効果**: 音読練習のペースをアプリが管理

- [ ] **3. テキスト表示/非表示切り替え**
  - [ ] ボタン1つでテキストエディタの表示/非表示を切り替え
  - [ ] 非表示時は音声プレイヤーのみ表示
  - [ ] `showText`状態、条件付きレンダリング
  - **ファイル**: `frontend/src/App.tsx`
  - **ファイル**: `frontend/src/components/features/AudioPlayer/AudioPlayer.tsx`
  - 所要時間: 1時間
  - ROI: ⭐⭐⭐⭐
  - **学習効果**: シャドーイング練習（テキストを見ない）、リスニング専念モード

**フェーズ3A（学習効果）合計**: 2.5-4時間

---

### 学習効果向上 - フェーズ3B: 学習管理・記録（高優先度）

**目標**: 継続性向上とモチベーション維持
**期待効果**: 継続日数+114%, 復習効率+50%, モチベーション+25%

- [ ] **4. 学習記録（練習履歴）**
  - [ ] 練習した日時、教材名、再生回数、総学習時間を記録
  - [ ] カレンダー形式で継続日数を可視化
  - [ ] localStorage使用（サーバー不要）
  - [ ] `LearningHistory.tsx`コンポーネント作成
  - [ ] `services/learningHistory.ts`でデータ管理
  - 所要時間: 3-4時間
  - ROI: ⭐⭐⭐⭐
  - **学習効果**: Duolingo式の連続記録、モチベーション維持

- [ ] **5. お気に入り・ブックマーク機能**
  - [ ] 特定の文をブックマーク（星マーク）
  - [ ] ブックマークした文のみを再生するモード
  - [ ] 苦手な文を重点的に練習
  - [ ] `sentences`に`bookmarked: boolean`を追加
  - [ ] localStorage保存（教材ごと）
  - 所要時間: 2-3時間
  - ROI: ⭐⭐⭐⭐
  - **学習効果**: 弱点克服に集中、効率的な復習

- [ ] **6. 速度変更の段階的練習モード**
  - [ ] 初回: 0.75x → 2回目: 1.0x → 3回目: 1.25x のように自動で速度UP
  - [ ] 段階的に難易度を上げる仕組み
  - [ ] `progressiveMode`状態、全文再生終了時に速度を自動変更
  - 所要時間: 2時間
  - ROI: ⭐⭐⭐
  - **学習効果**: 音読の段階的トレーニング（受験英語のノウハウ）

**フェーズ3B（学習効果）合計**: 7-9時間

---

## 🟢 中優先度（生徒フィードバック後に実施）

### 機能改善

- [ ] **ポーズ前の音被り問題の完全解決**
  - **現状**: 200msの無音を挿入したが、まだポーズ前に次の文の一瞬の音が聞こえる
  - **対策1**: ポーズ検知タイミングを0.1秒 → 0.25秒または0.3秒前に早める
  - **対策2**: 無音期間を200ms → 300msまたは400msに延長
  - **対策3**: ポーズロジックの最適化（シーク操作を即座に実行、状態管理改善）
  - **対策4**: 代替アプローチ（Web Audio API使用）の検討
  - **ファイル**: `frontend/src/components/features/AudioPlayer/AudioPlayer.tsx`
  - 所要時間: 1-2時間

- [ ] Error loading audioエラーの調査
  - **現状**: 詳細なエラーログを追加したが、まだ原因不明
  - **次回**: エラーログの詳細（code, message, networkState, readyState）を確認
  - **ファイル**: `frontend/src/components/features/AudioPlayer/AudioPlayer.tsx`
  - 所要時間: 30分

- [ ] パフォーマンステストとUI改善
  - [ ] 5文、10文、20文での生成時間測定
  - [ ] TTS生成の進捗表示UI追加
  - [ ] ローディング状態の改善
  - [ ] タイムアウト処理の確認
  - 所要時間: 1時間

- [ ] OCR精度の評価とチューニング
  - [ ] 様々な画像タイプでOCR精度を確認
  - [ ] 手書き除外機能のテスト
  - [ ] 多言語対応の確認
  - [ ] プロンプトの最適化（必要に応じて）
  - 所要時間: 30分

### パフォーマンス最適化

- [x] フロントエンド基本機能実装 ✅
- [x] サービス層実装 ✅
- [x] 音程保持機能実装（HTML5 Audio API） ✅

- [ ] IndexedDBキャッシュ実装（オプション）
  - [ ] 画像キャッシュ機能
  - [ ] 音声キャッシュ機能
  - [ ] キャッシュ管理UI
  - 所要時間: 2時間

- [ ] TTS生成の最適化
  - [ ] キャッシュ機構（同じテキストの再生成を避ける）
  - [ ] 長文（30文以上）のパフォーマンス改善
  - 所要時間: 1.5時間

## 🔵 低優先度

- [ ] PWA対応
  - [ ] Service Worker実装
  - [ ] manifest.json設定
  - [ ] オフライン対応
  - 所要時間: 2時間

- [ ] フロントエンドテスト実装
  - [ ] ユニットテスト
  - [ ] E2Eテスト
  - 所要時間: 2時間

- [ ] デプロイ設定
  - [ ] Vercel設定
  - [ ] Railway設定
  - [ ] CI/CD設定
  - 所要時間: 1時間

## 📝 備考

**次回セッションで参照すべきファイル:**
- `backend/app/services/openai_service.py` - TTS生成ロジック、pydub使用
- `backend/app/api/routes/tts.py` - /api/tts-with-timings エンドポイント
- `frontend/src/components/features/AudioPlayer/AudioPlayer.tsx` - タイムスタンプ使用ロジック

**次回セッション前の準備:**
- [ ] ffmpegがインストールされているか確認（`ffmpeg -version`）
  - Windowsの場合: https://ffmpeg.org/download.html からダウンロードしてPATHに追加
  - macOS: `brew install ffmpeg`
  - Linux: `sudo apt-get install ffmpeg`
- [ ] ブラウザのデベロッパーツールを開いてコンソールエラーを確認できる状態にする

**技術メモ:**
- pydubはffmpegに依存（音声ファイルの長さ測定に必要）
- 文ごとのTTS生成により、API使用量が増加（文数 × API呼び出し）
- タイムスタンプ精度: 95-99%（推定: 70-85%）
